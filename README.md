# pipeKV stream 

A minimal pipeline for segmenting, uploading, and streaming video content using Pipe Networkâ€™s KV storage â€” fully operated from a PoP node.

The system is split into:
- **Backend**: Bash + FastAPI (runs on pop-node server | VPS)
- **Frontend**: PHP + HLS.js player (served from a public web host)

---

## âš™ï¸ Overview

```
[Your PoP Node Server]
     |
     | (1) Upload .mp4 to server
     v
  [ts.sh script]
     |
     | (2) ffmpeg â†’ segment into .ts + .m3u8
     | (3) Upload to Pipe KV (need X-Service-Key)
     v
[PoP KV Storage]
     ^
     | (4) Fetch via FastAPI proxy (/m3u8 + /ts)
     v
[HLS.js Player]
```

### How it works

- The operator uploads an `.mp4` file directly to PoP node
- A bash script (`ts.sh`) segments the video and uploads all files to Pipe KV
- The `.m3u8` playlist is auto-patched to route segments via a FastAPI proxy
- A secure `/m3u8` and `/ts` proxy serves the content back to the browser
- The frontend player (PHP + HLS.js) streams everything directly from Pipe KV

---

## ðŸ“‚ Project Structure

### PoP Node (VPS)

```
pipekv-streamnode/
â”œâ”€â”€ .env            # Environment variables (X_SERVICE_KEY, ALLOWED_REF)
â”œâ”€â”€ ts.sh           # Bash script: ffmpeg segmenting + upload to Pipe KV
â”œâ”€â”€ pipe_api.py     # FastAPI server: proxy for /m3u8 and /ts endpoints 
â”œâ”€â”€ video.mp4     # your video file
```
### Web Hosting (Frontend)
```
/directory_root/
â”œâ”€â”€ .htaccess
â”œâ”€â”€ index.php              # Entry point UI for stream list
â”œâ”€â”€ player.php             # HLS.js player for a selected .m3u8
â”œâ”€â”€ m3u8_index_cache.json  # Playlist index (copy from VPS ./video/ after running ts.sh)
```

---

## Components

### in PoP Node (VPS)

* `ts.sh`
  a Bash script that segments `.mp4` files into `.ts` chunks and a `.m3u8` playlist using `ffmpeg`,
  then uploads all segments and the playlist to Pipe KV using your PoP node credentials.
  â†’ Before running, make sure to **create a `.env` file** with the following content:

  ```
  X_SERVICE_KEY=your-key-from-pop_state.json
  ```

  â†’ You can find your `X-Service-Key` in the `.pop_state.json` file, usually located in `/opt/popcache/`.

  â†’ The upload destination defaults to `https://127.0.0.1`, assuming your FastAPI proxy is running locally. You can adjust this via the `HOST` variable in the script if needed.


* `pipe_api.py`
  A FastAPI server that acts as a secure proxy for:

  * `/m3u8/{filename}` â†’ HLS playlists
  * `/ts/{filename}`   â†’ video segments

  It includes:
  * Origin/Referer validation
  * Protection against path traversal
  * CORS restrictions to only allow your frontend domain

  â†’ This script also uses the `.env` file. Set it up like this:

```
# Required PoP Node Service Key (used to access Pipe KV)
X_SERVICE_KEY=

# Allowed domain for CORS (frontend/player domain)
ALLOWED_REF=https://yourfrontend.domain
  ```

---

### Web Hosting (Frontend)

- `player.php` 
This is a simple HLS.js-based video player that streams `.m3u8` playlists and `.ts` segments from your own PoP nodeâ€™s FastAPI proxy.
#### Modify Proxy URL in `player.php`
By default, the script points to:
```php
$m3u8_url = "http://127.0.0.1:6969/m3u8/" . rawurlencode($filename);
```
Replace `http://127.0.0.1:6969` with your own PoP node domain or IP that runs the FastAPI ingest server (must be public-facing):
```php
$m3u8_url = "http://your-node-ip-or-domain:6969/m3u8/" . rawurlencode($filename);
```

- `index.php`  
  Displays the available playlists listed in `m3u8_index_cache.json`.  
  When clicked, redirects to `player.php`.

- `m3u8_index_cache.json`  
  Automatically generated by `ts.sh` (in VPS `./video/` directory).  
  Must be copied to the frontend host for `index.php` to display available streams.
---


## USAGE

###  Setup in your PoP Node server (VPS)

#### 1. Install dependencies

```bash
sudo apt update
sudo apt install screen ffmpeg python3-venv jq build-essential -y
````

#### 2. Create virtual environment & install Python requirements

```bash
python3 -m venv venv
source venv/bin/activate
pip install fastapi httpx uvicorn python-dotenv uvloop httptools
```
> `uvloop` and `httptools` improve performance and require `build-essential` to compile.

---


#### 3. Launch FastAPI proxy using screen

```bash;
screen -S pipeapi
uvicorn pipe_api:app \
  --host 0.0.0.0 \
  --port 6969 \
  --workers 2 \
  --loop uvloop \
  --http httptools
```

> Use `Ctrl+A, D` to detach the screen session.
> To reattach later, use `screen -r pipeapi`.

---

âš ï¸ **If your frontend uses HTTPS (SSL), you must launch Uvicorn with SSL certs to avoid browser blocking due to mixed content:**

```bash
uvicorn pipe_api:app \
  --host 0.0.0.0 \
  --port 6969 \
  --ssl-keyfile /etc/letsencrypt/live/yourdomain.com/privkey.pem \
  --ssl-certfile /etc/letsencrypt/live/yourdomain.com/fullchain.pem \
  --workers 2 \
  --loop uvloop \
  --http httptools
```

> Replace `yourdomain.com` with your actual domain name.
> Required if your HLS player is loaded over `https://`.

---

#### 4. Upload and process video

```bash
./ts.sh your_video.mp4
```

This will:

* Segment the video using `ffmpeg`
* Rewrite `.m3u8` to use `/ts/` proxy paths
* Upload segments and playlist to Pipe KV
* Update `m3u8_index_cache.json` under `./video/`

> Make sure to copy `m3u8_index_cache.json` to your PHP web hosting for the playlist list to work in `index.php`.

---

### Workflow

1. User downloads video.mp4 to the PoP node server (can use scp, wget, curl, or any preferred method)
2. PoP server receives file â†’ splits with ffmpeg â†’ uploads segments to KV
3. `.m3u8` generated and returned to browser
4. HLS.js streams content from Pipe KV via fastapi 

---

## Why This Project?
This project explores real-time video delivery via Pipe KV, showing how PoP nodes can act both as uploaders and content routers.


## Author
- Community Pipe Network

Unofficial community tool - not maintained by core team. Use with care.

## Reference
https://x.com/DavidRhodus/status/1929771104593498209

---


